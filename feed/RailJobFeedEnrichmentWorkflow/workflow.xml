<workflow-app name="Rail_Job_Feed" xmlns="uri:oozie:workflow:0.4">
  <credentials>
    <credential name="hcat" type="cbhcat">
      <property>
        <name>hcat.metastore.uri</name>
        <value>${metastoreUri}</value>
      </property>
    </credential>
  </credentials>

  <start to="job_feed_create_table"/>

  <!-- get data to temp table -->
  <action name="job_feed_create_table" cred="hcat">
    <shell xmlns="uri:oozie:shell-action:0.2">
      <job-tracker>${jobTracker}</job-tracker>
      <name-node>${nameNode}</name-node>
      <script>rails_jobs_all.hql</script>
    </shell>
    <ok to="success_master"/>
    <error to="fail_end"/>
  </action>

  <action name="success_master">
    <email xmlns="uri:oozie:email-action:0.1">
      <to>jobsmonitoring@careerbuilder.com</to>
      <subject>[${wf:name()}]-[master query ] has finished!</subject>
      <body>Feed 1  success https://www.youtube.com/watch?v=SPlQpGeTbIE</body>
    </email>
    <ok to="send_feed1_jobs_to_s3"/>
    <error to="send_feed1_jobs_to_s3"/>
  </action>

  <action name="fail_end">
    <email xmlns="uri:oozie:email-action:0.1">
      <to>jobsmonitoring@careerbuilder.com</to>
      <subject>[${wf:name()}]- [Master Query] has failed</subject>
      <body>Master Query Failed - Action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]</body>
    </email>
    <ok to="kill"/>
    <error to="kill"/>
  </action>

  <action name ="send_feed1_jobs_to_s3" cred="hcat">
    <shell xmlns="uri:oozie:shell-action:0.2">
      <job-tracker>${jobTracker}</job-tracker>
      <name-node>${nameNode}</name-node>
      <configuration>
        <property>
          <name>oozie.launcher.mapreduce.map.memory.mb</name>
          <value>4096</value>
        </property>
      </configuration>
      <exec>./feed_to_s3.sh</exec>
      <argument>feed_1</argument>
      <argument>1</argument>
      <file>feed_to_s3.sh</file>
      <file>feed.xslt</file>
    </shell>
    <ok to="success_1"/>
    <error to="fail_1"/>
  </action>

  <action name="fail_1">
    <email xmlns="uri:oozie:email-action:0.1">
      <to>jobsmonitoring@careerbuilder.com</to>
      <subject>[${wf:name()}]- [Feed 1] has failed</subject>
      <body>Feed 1 Failed - Action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]</body>
    </email>
    <ok to="kill"/>
    <error to="kill"/>
  </action>
  <action name="success_1">
    <email xmlns="uri:oozie:email-action:0.1">
      <to>jobsmonitoring@careerbuilder.com</to>
      <subject>[${wf:name()}]-[Feed 1] has finished!</subject>
      <body>Feed 1  success https://www.youtube.com/watch?v=SPlQpGeTbIE</body>
    </email>
    <ok to="end"/>
    <error to="kill"/>
  </action>

  <kill name="kill">
    <message>Action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]</message>
  </kill>
  <end name="end"/>
</workflow-app>
